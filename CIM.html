<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="format-detection" content="telephone=no">
<title>CIM.html</title>
<style>
html { -webkit-text-size-adjust: 100%; }
body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 14px; line-height: 1.428;
  max-width: 1000px;
  margin: 0 auto; padding: 0 15px;
}
h1, h2, h3, h4, h5, h6 { margin: 20px 0 10px; }
h1 { font-size: 28px; } h2 { font-size: 24px; }
h3 { font-size: 18px; } h4 { font-size: 16px; }
h5 { font-size: 14px; } h6 { font-size: 12px; }
a { color: #337AB7; text-decoration: none; }
a:hover { text-decoration: underline; }
img { max-width: 100%; height: auto; }
ul, ol { padding-left: 30px; }
pre, code, samp {
  font-size: 13px;
  font-family: Courier, monospace;
}
code, samp {
  background-color: #F5F5F5;
  border-radius: 3px; padding: 3px;
}
pre code, pre samp {
  white-space: pre; background: transparent;
  border: none; padding: 0;
}
pre {
  line-height: 1.33; background-color: #F5F5F5;
  border: 1px solid #CCCCCC; border-radius: 3px;
  padding: 8px; overflow: auto;
}
</style>
<style>
.stlog { color: #00FF00; background-color: #000000; }
.stres { color: #FFFF00; }
.stinp { color: #FFFFFF; }
.stcmd .stcmt { font-style: italic; opacity: 0.5; }
.stoom, .stcnp { font-style: italic; }
@media screen { .stcnp { display: none; }}
</style>
</head>
<body>
<html>
<head>
<title>CIM-METHODS</title>
</head>
<body>
<h2>TUTORIAL: CAUSAL INFERENCE METHODS MADE EASY FOR APPLIED RESEARCHERS/EPIDEMIOLOGISTS/STATISTICIANS</br>
<p></p>
CSG-LSHTM, LONDON, 6th December 2017</br>
<p></p>
Miguel Angel Luque Fernandez, PhD</br>
Assistant Professor of Epidemiology</br>
Cancer Survival Group, LSHTM, London, UK</br>
<p></p>
</h2>
<p>Copyright (c) 2017  <Miguel Angel Luque-Fernandez>
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.<br>
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NON INFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.</p>
<p>Bug reports: miguel-angel.luque at lshtm.ac.uk</p>
<h2>Content</h4>
<h3>I) DATA: Nomenclature (Globals and Naive approach)</br>
<p></p>
II) Non-parametric G-Formula</br>
<p></p>
III) Parametric G-Formula (G-Computation)</br>
<p></p>
IV)  Inverse Probability Weigthing</br>
<p></p>
V)   Double Robust Inverse Probability Weighthing plus Regression Adjustment</br>
<p></p>
<p></p>
VI)  Double Robust Augemented Inverse Probability Weighthing plus Regression Adjustment</br>
<p></p>
<p></p>
VII) Double Robust Targeted Maximum Likelihood Estimation</br>
<p></p>
<p></p>
VIII) Conclusion: simulation</br>
<p></p>
<p></p>
IX) Appendix: ELTMLE programme</br>
<p></p>
<h3> I) DATA: Nomenclature (Globals and Naive approach)</h3>
<pre id="stlog-1" class="stlog"><samp><span class="stinp">. clear </span>

<span class="stinp">. set more off</span>

<span class="stinp">. use http://www.stata-press.com/data/r14/cattaneo2.dta</span>
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

<span class="stinp">. describe</span>

Contains data from <span class="stres">http://www.stata-press.com/data/r14/cattaneo2.dta</span>
  obs:<span class="stres">         4,642                          Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154</span>
 vars:<span class="stres">            23                          14 Jan 2015 09:49</span>
 size:<span class="stres">       116,050                          </span>
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<span class="stres">bweight        </span> int     %9.0g                 <span class="stres">infant birthweight (grams)</span>
<span class="stres">mmarried       </span> byte    %10.0g     mmarried   <span class="stres">1 if mother married</span>
<span class="stres">mhisp          </span> byte    %9.0g                 <span class="stres">1 if mother hispanic</span>
<span class="stres">fhisp          </span> byte    %9.0g                 <span class="stres">1 if father hispanic</span>
<span class="stres">foreign        </span> byte    %9.0g                 <span class="stres">1 if mother born abroad</span>
<span class="stres">alcohol        </span> byte    %9.0g                 <span class="stres">1 if alcohol consumed during pregnancy</span>
<span class="stres">deadkids       </span> byte    %9.0g                 <span class="stres">previous births where newborn died</span>
<span class="stres">mage           </span> byte    %9.0g                 <span class="stres">mother's age</span>
<span class="stres">medu           </span> byte    %9.0g                 <span class="stres">mother's education attainment</span>
<span class="stres">fage           </span> byte    %9.0g                 <span class="stres">father's age</span>
<span class="stres">fedu           </span> byte    %9.0g                 <span class="stres">father's education attainment</span>
<span class="stres">nprenatal      </span> byte    %9.0g                 <span class="stres">number of prenatal care visits</span>
<span class="stres">monthslb       </span> int     %9.0g                 <span class="stres">months since last birth</span>
<span class="stres">order          </span> byte    %9.0g                 <span class="stres">order of birth of the infant</span>
<span class="stres">msmoke         </span> byte    %27.0g     smoke2     <span class="stres">cigarettes smoked during pregnancy</span>
<span class="stres">mbsmoke        </span> byte    %9.0g      mbsmoke    <span class="stres">1 if mother smoked</span>
<span class="stres">mrace          </span> byte    %9.0g                 <span class="stres">1 if mother is white</span>
<span class="stres">frace          </span> byte    %9.0g                 <span class="stres">1 if father is white</span>
<span class="stres">prenatal       </span> byte    %9.0g                 <span class="stres">trimester of first prenatal care visit</span>
<span class="stres">birthmonth     </span> byte    %9.0g                 <span class="stres">month of birth</span>
<span class="stres">lbweight       </span> byte    %9.0g                 <span class="stres">1 if low birthweight baby</span>
<span class="stres">fbaby          </span> byte    %9.0g      YesNo      <span class="stres">1 if first baby</span>
<span class="stres">prenatal1      </span> byte    %9.0g      YesNo      <span class="stres">1 if first prenatal visit in 1 trimester</span>
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Sorted by: 

<span class="stinp">. global Y bweight <span class="stcmt">// Outcome</span></span>

<span class="stinp">. global A mbsmoke <span class="stcmt">// Exposure or treatment</span></span>

<span class="stinp">. global C mmarried  <span class="stcmt">// Confounder </span></span>

<span class="stinp">. global W mmarried prenatal1 fbaby medu mage foreign mrace <span class="stcmt">// Confounders</span></span>

<span class="stinp">. regr $Y $A $C <span class="stcmt">// Naive approach</span></span>

      Source |       SS           df       MS      Number of obs   =<span class="stres">     4,642</span>
-------------+----------------------------------   F(2, 4639)      = <span class="stres">   132.55</span>
       Model | <span class="stres"> 84050074.2         2  42025037.1   </span>Prob &gt; F        =<span class="stres">    0.0000</span>
    Residual | <span class="stres"> 1.4708e+09     4,639  317058.453   </span>R-squared       =<span class="stres">    0.0541</span>
-------------+----------------------------------   Adj R-squared   =<span class="stres">    0.0536</span>
       Total | <span class="stres"> 1.5549e+09     4,641  335032.156   </span>Root MSE        =   <span class="stres"> 563.08</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |<span class="stres">  -224.4212   21.85195   -10.27   0.000    -267.2614    -181.581</span>
    mmarried |<span class="stres">    182.794   18.55405     9.85   0.000     146.4193    219.1688</span>
       _cons |<span class="stres">    3275.55   16.68283   196.34   0.000     3242.844    3308.256</span>
------------------------------------------------------------------------------
</samp></pre>
<h3> IIa) Non Parametric G-FORMULA by hand: one confounder </h3>
<h4> ATE: First compute the marginal probability for confounder C</h4>
<pre id="stlog-2" class="stlog"><samp><span class="stinp">. proportion $C</span>

Proportion estimation             Number of obs   = <span class="stres">     4,642</span>

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
<span class="stres">mmarried     </span>|
  notmarried |<span class="stres">   .3003016   .0067287      .2872778     .313656</span>
     married |<span class="stres">   .6996984   .0067287       .686344    .7127222</span>
--------------------------------------------------------------

<span class="stinp">. matrix m=e(b)</span>

<span class="stinp">. gen mmarried1 = m[1,2]</span>

<span class="stinp">. sum mmarried1</span>

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
   mmarried1 |<span class="stres">      4,642    .6996984           0   .6996984   .6996984</span>

<span class="stinp">. gen mmarried2 = m[1,1]</span>

<span class="stinp">. sum mmarried2</span>

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
   mmarried2 |<span class="stres">      4,642    .3003016           0   .3003016   .3003016</span>
</samp></pre>
<h4> ATE: Second compute the G-Formula by hand (generalization of standardization)</h4>
<pre id="stlog-3" class="stlog"><samp><span class="stinp">. sumup $Y, by($A $C)</span>

mbsmoke mmarried |       Obs    Missing       Mean  Std. Dev.        Min        Max 
-----------------+------------------------------------------------------------------
nonsmok notmarri |  <span class="stres">      939          0   3258.925   635.8025        454       4933</span>
nonsmok married  |  <span class="stres">     2839          0   3463.843   537.9523        340       5500</span>
smoker  notmarri |  <span class="stres">      455          0   3085.437   548.4611        397       5018</span>
smoker  married  |  <span class="stres">      409          0   3195.756    569.468        482       4734</span>
-----------------+------------------------------------------------------------------
 Total           |  <span class="stres">     4642          0    3361.68   578.8196        340       5500</span>
------------------------------------------------------------------------------------

<span class="stinp">. matrix y00 = r(Stat1)</span>

<span class="stinp">. matrix y01 = r(Stat2)</span>

<span class="stinp">. matrix y10 = r(Stat3)</span>

<span class="stinp">. matrix y11 = r(Stat4)</span>

<span class="stinp">. gen ATE = ((y11[3,1]-y01[3,1]))*mmarried1 + ((y10[3,1]-y00[3,1]))*mmarried2</span>

<span class="stinp">. qui: sum ATE</span>

<span class="stinp">. display "The ATE is:  " `r(mean)'</span>
<span class="stres">The ATE is:  -239.67882</span>

<span class="stinp">. drop ATE </span>

<span class="stinp">. *Check Stata implementation results</span>
<span class="stinp">. teffects ra ($Y $C) ($A)</span>

Iteration 0:   EE criterion = <span class="stres"> 1.549e-24</span>  
Iteration 1:   EE criterion = <span class="stres"> 5.234e-26</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: none</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -239.6788   23.14732   -10.35   0.000    -285.0467   -194.3109</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3402.306    9.51684   357.50   0.000     3383.653    3420.958</span>
----------------------------------------------------------------------------------------
</samp></pre>
<h4> How about identififiability: ATET </h4>
<pre id="stlog-4" class="stlog"><samp><span class="stinp">. proportion $C if $A==1</span>

Proportion estimation             Number of obs   = <span class="stres">       864</span>

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
<span class="stres">mmarried     </span>|
  notmarried |<span class="stres">   .5266204   .0169961      .4931927    .5598111</span>
     married |<span class="stres">   .4733796   .0169961      .4401889    .5068073</span>
--------------------------------------------------------------

<span class="stinp">. matrix m=e(b)</span>

<span class="stinp">. gen mmarried1atet = m[1,2]</span>

<span class="stinp">. gen mmarried2atet = m[1,1]</span>

<span class="stinp">. gen ATT = ((y11[3,1]-y01[3,1]))*mmarried1atet + ((y10[3,1]-y00[3,1]))*mmarried2atet</span>

<span class="stinp">. qui: sum ATT </span>

<span class="stinp">. display "The ATT is:  " `r(mean)'</span>
<span class="stres">The ATT is:  -218.26932</span>

<span class="stinp">. *Check restuls Stata Implementation</span>
<span class="stinp">. teffects ra ($Y $C) ($A), atet</span>

Iteration 0:   EE criterion = <span class="stres"> 1.503e-24</span>  
Iteration 1:   EE criterion = <span class="stres"> 3.239e-26</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: none</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATET                   </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -218.2693    22.4693    -9.71   0.000    -262.3083   -174.2303</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3355.929   12.41832   270.24   0.000      3331.59    3380.268</span>
----------------------------------------------------------------------------------------

<span class="stinp">. drop ATT</span>
</samp></pre>
<h4> Non-parametric G-Formula: Bostrapping for the ATE SE and 95%CI </h4>
<pre id="stlog-5" class="stlog"><samp><span class="stinp">. program drop ATE</span>

<span class="stinp">. program define ATE, rclass</span>
  1<span class="stinp">. capture drop y1</span>
  2<span class="stinp">. capture drop y0</span>
  3<span class="stinp">. capture drop ATE</span>
  4<span class="stinp">. sumup $Y, by($A $C)</span>
  5<span class="stinp">. matrix y00 = r(Stat1)</span>
  6<span class="stinp">. matrix y01 = r(Stat2)</span>
  7<span class="stinp">. matrix y10 = r(Stat3)</span>
  8<span class="stinp">. matrix y11 = r(Stat4)</span>
  9<span class="stinp">. gen ATE = ((y11[3,1]-y01[3,1]))*mmarried1 + ((y10[3,1]-y00[3,1]))*mmarried2</span>
 10<span class="stinp">. qui sum ATE</span>
 11<span class="stinp">. return scalar ate = `r(mean)'</span>
 12<span class="stinp">. end</span>

<span class="stinp">. qui bootstrap r(ate), reps(1000): ATE</span>

<span class="stinp">. estat boot, all</span>

Bootstrap results                               Number of obs     = <span class="stres">     4,642</span>
                                                Replications      = <span class="stres">      1000</span>

      command:  ATE
        _bs_1:  <span class="stres">r(ate)</span>

------------------------------------------------------------------------------
             |    Observed               Bootstrap
<span class="stres">             </span>|       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _bs_1 |<span class="stres">  -239.67882     .56238    23.21251   -285.1745  -194.1831</span>   (N)
<span class="stres">             </span>|                                    <span class="stres">  -287.5401  -193.4211</span>   (P)
<span class="stres">             </span>|                                    <span class="stres">  -291.1595  -197.7737</span>  (BC)
------------------------------------------------------------------------------
(N)    normal confidence interval
(P)    percentile confidence interval
(BC)   bias-corrected confidence interval

<span class="stinp">. drop ATE </span>
</samp></pre>
<h4> Non-parametric G-Formula: Bostrapping for the ATET SE and 95%CI </h4>
<pre id="stlog-6" class="stlog"><samp><span class="stinp">. program drop ATE</span>

<span class="stinp">. program define ATE, rclass</span>
  1<span class="stinp">. capture drop y1</span>
  2<span class="stinp">. capture drop y0</span>
  3<span class="stinp">. capture drop ATT</span>
  4<span class="stinp">. sumup $Y, by($A $C)</span>
  5<span class="stinp">. matrix y00 = r(Stat1)</span>
  6<span class="stinp">. matrix y01 = r(Stat2)</span>
  7<span class="stinp">. matrix y10 = r(Stat3)</span>
  8<span class="stinp">. matrix y11 = r(Stat4)</span>
  9<span class="stinp">. gen ATT = ((y11[3,1]-y01[3,1]))*mmarried1atet + ((y10[3,1]-y00[3,1]))*mmarried2atet</span>
 10<span class="stinp">. qui sum ATT</span>
 11<span class="stinp">. return scalar atet = `r(mean)'</span>
 12<span class="stinp">. end</span>

<span class="stinp">. qui bootstrap r(atet), reps(1000): ATE</span>

<span class="stinp">. estat boot, all</span>

Bootstrap results                               Number of obs     = <span class="stres">     4,642</span>
                                                Replications      = <span class="stres">      1000</span>

      command:  ATE
        _bs_1:  <span class="stres">r(atet)</span>

------------------------------------------------------------------------------
             |    Observed               Bootstrap
<span class="stres">             </span>|       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _bs_1 |<span class="stres">  -218.26932   .1785775   21.729215   -260.8578  -175.6808</span>   (N)
<span class="stres">             </span>|                                    <span class="stres">  -261.1092  -177.6079</span>   (P)
<span class="stres">             </span>|                                    <span class="stres">  -261.2072  -177.6395</span>  (BC)
------------------------------------------------------------------------------
(N)    normal confidence interval
(P)    percentile confidence interval
(BC)   bias-corrected confidence interval

<span class="stinp">. drop ATT </span>
</samp></pre>
<h3> IIb) Non-parametric implementation of the G-Formula using a fully saturated regression model</h3>
<pre id="stlog-7" class="stlog"><samp><span class="stinp">. regress $Y ibn.$A ibn.$A#c.($C), noconstant vce(robust)</span>

Linear regression                               Number of obs     = <span class="stres">     4,642</span>
<span class="stres">                                                </span>F(4, 4638)        =  <span class="stres"> 42409.94</span>
<span class="stres">                                                </span>Prob &gt; F          = <span class="stres">    0.0000</span>
<span class="stres">                                                </span>R-squared         = <span class="stres">    0.9728</span>
<span class="stres">                                                </span>Root MSE          =    <span class="stres"> 562.86</span>

------------------------------------------------------------------------------------
                   |               Robust
           bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------------+----------------------------------------------------------------
           mbsmoke |
        nonsmoker  |<span class="stres">   3258.925   20.74652   157.08   0.000     3218.252    3299.599</span>
           smoker  |<span class="stres">   3085.437   25.69505   120.08   0.000     3035.063    3135.812</span>
                   |
mbsmoke#c.mmarried |
        nonsmoker  |<span class="stres">   204.9171    23.0739     8.88   0.000     159.6813    250.1529</span>
           smoker  |<span class="stres">   110.3181   38.10346     2.90   0.004     35.61724     185.019</span>
------------------------------------------------------------------------------------

<span class="stinp">. margins $A, vce(unconditional) <span class="stcmt">// Marginal probabilty for C</span></span>

Predictive margins                              Number of obs     = <span class="stres">     4,642</span>

Expression   : <span class="stres">Linear prediction, predict()</span>

------------------------------------------------------------------------------
             |            Unconditional
             |     Margin   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |
  nonsmoker  |<span class="stres">   3402.306   9.520943   357.35   0.000      3383.64    3420.971</span>
     smoker  |<span class="stres">   3162.627   21.15799   149.48   0.000     3121.147    3204.107</span>
------------------------------------------------------------------------------

<span class="stinp">. margins r.$A, contrast(nowald) <span class="stcmt">// Check R meaning ....</span></span>

Contrasts of predictive margins
Model VCE    : <span class="stres">Robust</span>

Expression   : <span class="stres">Linear prediction, predict()</span>

------------------------------------------------------------------------
                       |            Delta-method
                       |   Contrast   Std. Err.     [95% Conf. Interval]
-----------------------+------------------------------------------------
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -239.6788   23.14854      -285.061   -194.2967</span>
------------------------------------------------------------------------
</samp></pre>
<h4> Note about margins Uncoditional </h4>
<pre id="stlog-8" class="stlog"><samp><span class="stinp">. regress $Y ibn.$A ibn.$A#c.($C), noconstant vce(robust) coeflegend</span>

Linear regression                               Number of obs     = <span class="stres">     4,642</span>
<span class="stres">                                                </span>F(4, 4638)        =  <span class="stres"> 42409.94</span>
<span class="stres">                                                </span>Prob &gt; F          = <span class="stres">    0.0000</span>
<span class="stres">                                                </span>R-squared         = <span class="stres">    0.9728</span>
<span class="stres">                                                </span>Root MSE          =    <span class="stres"> 562.86</span>

------------------------------------------------------------------------------------
           bweight |      Coef.  Legend
-------------------+----------------------------------------------------------------
           mbsmoke |
        nonsmoker  |<span class="stres">   3258.925</span>  _b[0bn.mbsmoke]
           smoker  |<span class="stres">   3085.437</span>  _b[1.mbsmoke]
                   |
mbsmoke#c.mmarried |
        nonsmoker  |<span class="stres">   204.9171</span>  _b[0bn.mbsmoke#c.mmarried]
           smoker  |<span class="stres">   110.3181</span>  _b[1.mbsmoke#c.mmarried]
------------------------------------------------------------------------------------

<span class="stinp">. predictnl ATE = (_b[1bn.mbsmoke] + _b[1bn.mbsmoke#c.mmarried]*mmarried) - (_b[0bn.mbsmoke] + _b[0bn.mbsmoke#c.mmarried]*mmarried)</span>

<span class="stinp">. qui: sum ATE</span>

<span class="stinp">. display "The ATE is:  " `r(mean)'</span>
<span class="stres">The ATE is:  -239.67882</span>

<span class="stinp">. drop ATE</span>
</samp></pre>
<h3> III) G-Computation or parametric G-Formula </h3>
<pre id="stlog-9" class="stlog"><samp><span class="stinp">. teffects ra ($Y $C) ($A) <span class="stcmt">//Parametric G-Formula implementation in Stata</span></span>

Iteration 0:   EE criterion = <span class="stres"> 1.549e-24</span>  
Iteration 1:   EE criterion = <span class="stres"> 5.234e-26</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: none</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -239.6788   23.14732   -10.35   0.000    -285.0467   -194.3109</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3402.306    9.51684   357.50   0.000     3383.653    3420.958</span>
----------------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. regress $Y $C if $A==1</span>

      Source |       SS           df       MS      Number of obs   =<span class="stres">       864</span>
-------------+----------------------------------   F(1, 862)       = <span class="stres">     8.40</span>
       Model | <span class="stres"> 2621288.44         1  2621288.44   </span>Prob &gt; F        =<span class="stres">    0.0038</span>
    Residual | <span class="stres">  268879388       862  311925.044   </span>R-squared       =<span class="stres">    0.0097</span>
-------------+----------------------------------   Adj R-squared   =<span class="stres">    0.0085</span>
       Total | <span class="stres">  271500676       863  314601.015   </span>Root MSE        =   <span class="stres">  558.5</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">   110.3181   38.05526     2.90   0.004     35.62633    185.0099</span>
       _cons |<span class="stres">   3085.437     26.183   117.84   0.000     3034.047    3136.827</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double y1hat </span>
(option <span class="stres">xb</span> assumed; fitted values)

<span class="stinp">. regress $Y $C if $A==0 </span>

      Source |       SS           df       MS      Number of obs   =<span class="stres">     3,778</span>
-------------+----------------------------------   F(1, 3776)      = <span class="stres">    93.20</span>
       Model | <span class="stres"> 29629575.1         1  29629575.1   </span>Prob &gt; F        =<span class="stres">    0.0000</span>
    Residual | <span class="stres"> 1.2005e+09     3,776  317923.211   </span>R-squared       =<span class="stres">    0.0241</span>
-------------+----------------------------------   Adj R-squared   =<span class="stres">    0.0238</span>
       Total | <span class="stres"> 1.2301e+09     3,777  325683.776   </span>Root MSE        =   <span class="stres"> 563.85</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">   204.9171   21.22641     9.65   0.000     163.3008    246.5334</span>
       _cons |<span class="stres">   3258.925   18.40044   177.11   0.000      3222.85    3295.001</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double y0hat </span>
(option <span class="stres">xb</span> assumed; fitted values)

<span class="stinp">. mean y1hat y0hat</span>

Mean estimation                   Number of obs   = <span class="stres">     4,642</span>

--------------------------------------------------------------
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
       y1hat |<span class="stres">   3162.627   .7422931      3161.172    3164.082</span>
       y0hat |<span class="stres">   3402.306   1.378817      3399.602    3405.009</span>
--------------------------------------------------------------

<span class="stinp">. lincom _b[y1hat] - _b[y0hat]</span>

 ( 1)  <span class="stres">y1hat - y0hat = 0</span>

------------------------------------------------------------------------------
        Mean |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |<span class="stres">  -239.6788   .6365241  -376.54   0.000    -240.9267   -238.4309</span>
------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. * Bostrapping to get the SE and 95%CI for the ATE </span>
<span class="stinp">. capture program drop ATE</span>

<span class="stinp">. program define ATE, rclass</span>
  1<span class="stinp">. capture drop y1</span>
  2<span class="stinp">. capture drop y0</span>
  3<span class="stinp">. reg $Y $C if $A==1 </span>
  4<span class="stinp">. predict double y1, xb</span>
  5<span class="stinp">. quiet sum y1</span>
  6<span class="stinp">. reg $Y $C if $A==0 </span>
  7<span class="stinp">. predict double y0, xb </span>
  8<span class="stinp">. quiet sum y0</span>
  9<span class="stinp">. mean y1 y0 </span>
 10<span class="stinp">. lincom _b[y1]-_b[y0]</span>
 11<span class="stinp">. return scalar ace =`r(estimate)'</span>
 12<span class="stinp">. end</span>

<span class="stinp">. qui bootstrap r(ace), reps(1000): ATE</span>

<span class="stinp">. estat boot, all</span>

Bootstrap results                               Number of obs     = <span class="stres">     4,642</span>
                                                Replications      = <span class="stres">      1000</span>

      command:  ATE
        _bs_1:  <span class="stres">r(ace)</span>

------------------------------------------------------------------------------
             |    Observed               Bootstrap
<span class="stres">             </span>|       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _bs_1 |<span class="stres">  -239.67883   .1668729   23.365851   -285.4751  -193.8826</span>   (N)
<span class="stres">             </span>|                                    <span class="stres">  -284.6081  -194.4855</span>   (P)
<span class="stres">             </span>|                                    <span class="stres">  -284.5827  -194.4103</span>  (BC)
------------------------------------------------------------------------------
(N)    normal confidence interval
(P)    percentile confidence interval
(BC)   bias-corrected confidence interval
</samp></pre>
<h3> III) G-Computation or parametric G-Formula for more than one confounder</h3>
<pre id="stlog-10" class="stlog"><samp><span class="stinp">. clear</span>

<span class="stinp">. use http://www.stata-press.com/data/r14/cattaneo2.dta</span>
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

<span class="stinp">. </span>
<span class="stinp">. // Stata Implementation</span>
<span class="stinp">. teffects ra ($Y $W) ($A)</span>

Iteration 0:   EE criterion = <span class="stres"> 3.484e-23</span>  
Iteration 1:   EE criterion = <span class="stres"> 7.862e-26</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: none</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -239.0757    25.1374    -9.51   0.000    -288.3441   -189.8073</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3406.643   9.442598   360.77   0.000     3388.136    3425.151</span>
----------------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. // Non Parametric G-FORMULA with multiple variables</span>
<span class="stinp">. regress $Y ibn.$A       ibn.$A#c.($W), noconstant vce(robust)</span>

Linear regression                               Number of obs     = <span class="stres">     4,642</span>
<span class="stres">                                                </span>F(16, 4626)       =  <span class="stres"> 11378.26</span>
<span class="stres">                                                </span>Prob &gt; F          = <span class="stres">    0.0000</span>
<span class="stres">                                                </span>R-squared         = <span class="stres">    0.9737</span>
<span class="stres">                                                </span>Root MSE          =    <span class="stres"> 554.06</span>

-------------------------------------------------------------------------------------
                    |               Robust
            bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
--------------------+----------------------------------------------------------------
            mbsmoke |
         nonsmoker  |<span class="stres">   3026.142   62.15547    48.69   0.000     2904.287    3147.996</span>
            smoker  |<span class="stres">   3034.277    126.282    24.03   0.000     2786.704     3281.85</span>
                    |
 mbsmoke#c.mmarried |
         nonsmoker  |<span class="stres">   61.97948    27.7798     2.23   0.026     7.517833    116.4411</span>
            smoker  |<span class="stres">   88.85613   42.22493     2.10   0.035      6.07513    171.6371</span>
                    |
mbsmoke#c.prenatal1 |
         nonsmoker  |<span class="stres">   30.83669   26.80587     1.15   0.250     -21.7156    83.38897</span>
            smoker  |<span class="stres">  -5.674673   41.07336    -0.14   0.890    -86.19804     74.8487</span>
                    |
    mbsmoke#c.fbaby |
         nonsmoker  |<span class="stres">  -90.14129    19.9636    -4.52   0.000    -129.2795   -51.00311</span>
            smoker  |<span class="stres">   24.82468   39.98648     0.62   0.535     -53.5679    103.2173</span>
                    |
     mbsmoke#c.medu |
         nonsmoker  |<span class="stres">   4.654846   3.844754     1.21   0.226    -2.882706     12.1924</span>
            smoker  |<span class="stres">   8.144071   7.764126     1.05   0.294     -7.07732    23.36546</span>
                    |
     mbsmoke#c.mage |
         nonsmoker  |<span class="stres">   1.863902   2.163618     0.86   0.389     -2.37782    6.105625</span>
            smoker  |<span class="stres">  -7.128437   4.218267    -1.69   0.091    -15.39825    1.141379</span>
                    |
  mbsmoke#c.foreign |
         nonsmoker  |<span class="stres">  -22.88371   39.80293    -0.57   0.565    -100.9164    55.14901</span>
            smoker  |<span class="stres">   158.5796   114.2716     1.39   0.165    -65.44728    382.6064</span>
                    |
    mbsmoke#c.mrace |
         nonsmoker  |<span class="stres">   291.0515   33.25878     8.75   0.000     225.8485    356.2546</span>
            smoker  |<span class="stres">   168.8261   54.49301     3.10   0.002     61.99386    275.6584</span>
-------------------------------------------------------------------------------------

<span class="stinp">. margins $A, vce(unconditional)</span>

Predictive margins                              Number of obs     = <span class="stres">     4,642</span>

Expression   : <span class="stres">Linear prediction, predict()</span>

------------------------------------------------------------------------------
             |            Unconditional
             |     Margin   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |
  nonsmoker  |<span class="stres">   3406.643   9.458914   360.15   0.000     3388.099    3425.187</span>
     smoker  |<span class="stres">   3167.568   23.42163   135.24   0.000      3121.65    3213.485</span>
------------------------------------------------------------------------------

<span class="stinp">. margins r.$A, contrast(nowald)</span>

Contrasts of predictive margins
Model VCE    : <span class="stres">Robust</span>

Expression   : <span class="stres">Linear prediction, predict()</span>

------------------------------------------------------------------------
                       |            Delta-method
                       |   Contrast   Std. Err.     [95% Conf. Interval]
-----------------------+------------------------------------------------
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -239.0757   25.12453     -288.3318   -189.8197</span>
------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. // G-Computation or parametric G-Formula computation</span>
<span class="stinp">. regress $Y $W if $A==1</span>

      Source |       SS           df       MS      Number of obs   =<span class="stres">       864</span>
-------------+----------------------------------   F(7, 856)       = <span class="stres">     4.05</span>
       Model | <span class="stres"> 8703761.59         7  1243394.51   </span>Prob &gt; F        =<span class="stres">    0.0002</span>
    Residual | <span class="stres">  262796914       856  307005.741   </span>R-squared       =<span class="stres">    0.0321</span>
-------------+----------------------------------   Adj R-squared   =<span class="stres">    0.0241</span>
       Total | <span class="stres">  271500676       863  314601.015   </span>Root MSE        =   <span class="stres"> 554.08</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">   88.85613   43.55466     2.04   0.042     3.369693    174.3426</span>
   prenatal1 |<span class="stres">  -5.674673    44.6082    -0.13   0.899    -93.22893    81.87959</span>
       fbaby |<span class="stres">   24.82468   42.24249     0.59   0.557    -58.08632    107.7357</span>
        medu |<span class="stres">   8.144071   9.431183     0.86   0.388    -10.36688    26.65502</span>
        mage |<span class="stres">  -7.128437   4.075119    -1.75   0.081    -15.12683    .8699587</span>
     foreign |<span class="stres">   158.5796   121.1829     1.31   0.191     -79.2709      396.43</span>
       mrace |<span class="stres">   168.8261   52.84241     3.19   0.001     65.11027     272.542</span>
       _cons |<span class="stres">   3034.277   133.0632    22.80   0.000     2773.108    3295.445</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double y1hat </span>
(option <span class="stres">xb</span> assumed; fitted values)

<span class="stinp">. regress $Y $W if $A==0 </span>

      Source |       SS           df       MS      Number of obs   =<span class="stres">     3,778</span>
-------------+----------------------------------   F(7, 3770)      = <span class="stres">    33.88</span>
       Model | <span class="stres"> 72795077.5         7  10399296.8   </span>Prob &gt; F        =<span class="stres">    0.0000</span>
    Residual | <span class="stres"> 1.1573e+09     3,770  306979.454   </span>R-squared       =<span class="stres">    0.0592</span>
-------------+----------------------------------   Adj R-squared   =<span class="stres">    0.0574</span>
       Total | <span class="stres"> 1.2301e+09     3,777  325683.776   </span>Root MSE        =   <span class="stres"> 554.06</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">   61.97948    26.2361     2.36   0.018     10.54116    113.4178</span>
   prenatal1 |<span class="stres">   30.83669   25.85499     1.19   0.233    -19.85444    81.52781</span>
       fbaby |<span class="stres">  -90.14129   19.50776    -4.62   0.000    -128.3881    -51.8945</span>
        medu |<span class="stres">   4.654846   4.097495     1.14   0.256    -3.378676    12.68837</span>
        mage |<span class="stres">   1.863902   2.024667     0.92   0.357    -2.105647    5.833452</span>
     foreign |<span class="stres">  -22.88371   39.00843    -0.59   0.557    -99.36337    53.59596</span>
       mrace |<span class="stres">   291.0515   28.31813    10.28   0.000     235.5312    346.5719</span>
       _cons |<span class="stres">   3026.142   59.78945    50.61   0.000     2908.919    3143.364</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double y0hat </span>
(option <span class="stres">xb</span> assumed; fitted values)

<span class="stinp">. mean y1hat y0hat</span>

Mean estimation                   Number of obs   = <span class="stres">     4,642</span>

--------------------------------------------------------------
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
       y1hat |<span class="stres">   3167.568   1.353491      3164.914    3170.221</span>
       y0hat |<span class="stres">   3406.643   2.051065      3402.622    3410.664</span>
--------------------------------------------------------------

<span class="stinp">. lincom _b[y1hat] - _b[y0hat]</span>

 ( 1)  <span class="stres">y1hat - y0hat = 0</span>

------------------------------------------------------------------------------
        Mean |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |<span class="stres">  -239.0757   1.561876  -153.07   0.000    -242.1378   -236.0137</span>
------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. * Bostrapping to get the SE and 95%CI for the ATE capture program drop ATE</span>
<span class="stinp">. program drop ATE</span>

<span class="stinp">. program define ATE, rclass</span>
  1<span class="stinp">. capture drop y1</span>
  2<span class="stinp">. capture drop y0</span>
  3<span class="stinp">. reg $Y $W if $A==1 </span>
  4<span class="stinp">. predict double y1, xb</span>
  5<span class="stinp">. quiet sum y1</span>
  6<span class="stinp">. reg $Y $W if $A==0 </span>
  7<span class="stinp">. predict double y0, xb </span>
  8<span class="stinp">. quiet sum y0</span>
  9<span class="stinp">. mean y1 y0 </span>
 10<span class="stinp">. lincom _b[y1]-_b[y0]</span>
 11<span class="stinp">. return scalar ace =`r(estimate)'</span>
 12<span class="stinp">. end</span>

<span class="stinp">. qui bootstrap r(ace), reps(1000): ATE dots</span>

<span class="stinp">. estat boot, all</span>

Bootstrap results                               Number of obs     = <span class="stres">     4,642</span>
                                                Replications      = <span class="stres">      1000</span>

      command:  ATE dots
        _bs_1:  <span class="stres">r(ace)</span>

------------------------------------------------------------------------------
             |    Observed               Bootstrap
<span class="stres">             </span>|       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _bs_1 |<span class="stres">  -239.07573   .9380744   24.832592   -287.7467  -190.4047</span>   (N)
<span class="stres">             </span>|                                    <span class="stres">  -289.9457  -192.0624</span>   (P)
<span class="stres">             </span>|                                    <span class="stres">  -293.7208  -193.5329</span>  (BC)
------------------------------------------------------------------------------
(N)    normal confidence interval
(P)    percentile confidence interval
(BC)   bias-corrected confidence interval

<span class="stinp">. </span>
<span class="stinp">. // Possibilities of G-compuation in Stata </span>
<span class="stinp">. * Potential Outcomes</span>
<span class="stinp">. teffects ra ($Y $W) ($A), aequations</span>

Iteration 0:   EE criterion = <span class="stres"> 3.484e-23</span>  
Iteration 1:   EE criterion = <span class="stres"> 7.862e-26</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: none</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -239.0757    25.1374    -9.51   0.000    -288.3441   -189.8073</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3406.643   9.442598   360.77   0.000     3388.136    3425.151</span>
-----------------------+----------------------------------------------------------------
<span class="stres">OME0                   </span>|
              mmarried |<span class="stres">   61.97948   27.73188     2.23   0.025     7.625998     116.333</span>
             prenatal1 |<span class="stres">   30.83669   26.75963     1.15   0.249    -21.61122     83.2846</span>
                 fbaby |<span class="stres">  -90.14129   19.92916    -4.52   0.000    -129.2017   -51.08085</span>
                  medu |<span class="stres">   4.654846   3.838122     1.21   0.225    -2.867736    12.17743</span>
                  mage |<span class="stres">   1.863902   2.159886     0.86   0.388    -2.369396    6.097201</span>
               foreign |<span class="stres">  -22.88371   39.73427    -0.58   0.565    -100.7614    54.99404</span>
                 mrace |<span class="stres">   291.0515   33.20142     8.77   0.000      225.978    356.1251</span>
                 _cons |<span class="stres">   3026.142   62.04826    48.77   0.000     2904.529    3147.754</span>
-----------------------+----------------------------------------------------------------
<span class="stres">OME1                   </span>|
              mmarried |<span class="stres">   88.85613   42.15209     2.11   0.035      6.23954    171.4727</span>
             prenatal1 |<span class="stres">  -5.674673   41.00251    -0.14   0.890    -86.03812    74.68877</span>
                 fbaby |<span class="stres">   24.82468   39.91751     0.62   0.534     -53.4122    103.0616</span>
                  medu |<span class="stres">   8.144071   7.750734     1.05   0.293    -7.047089    23.33523</span>
                  mage |<span class="stres">  -7.128437   4.210991    -1.69   0.090    -15.38183    1.124954</span>
               foreign |<span class="stres">   158.5796   114.0745     1.39   0.164    -65.00235    382.1615</span>
                 mrace |<span class="stres">   168.8261   54.39902     3.10   0.002     62.20603    275.4463</span>
                 _cons |<span class="stres">   3034.277   126.0642    24.07   0.000     2787.195    3281.358</span>
----------------------------------------------------------------------------------------

<span class="stinp">. * Relative Risk</span>
<span class="stinp">. teffects ra ($Y $W) ($A), coeflegend</span>

Iteration 0:   EE criterion = <span class="stres"> 3.484e-23</span>  
Iteration 1:   EE criterion = <span class="stres"> 7.862e-26</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: none</span>
----------------------------------------------------------------------------------------
               bweight |      Coef.  Legend
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -239.0757</span>  _b[ATE:r1vs0.mbsmoke]
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3406.643</span>  _b[POmean:0.mbsmoke]
----------------------------------------------------------------------------------------

<span class="stinp">. nlcom 100*_b[ATE:r1vs0.mbsmoke]/_b[POmean:0.mbsmoke]</span>

       _nl_1:  <span class="stres">100*_b[ATE:r1vs0.mbsmoke]/_b[POmean:0.mbsmoke]</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _nl_1 |<span class="stres">  -7.017927   .7309724    -9.60   0.000    -8.450606   -5.585247</span>
------------------------------------------------------------------------------
</samp></pre>
<h3> IV) INVERSE PROBABILITY WEIGTHING (IPW) based on the Propensity Score</h3>
<pre id="stlog-11" class="stlog"><samp><span class="stinp">. clear</span>

<span class="stinp">. use http://www.stata-press.com/data/r14/cattaneo2.dta</span>
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

<span class="stinp">. teffects ipw ($Y) ($A $W, logit), nolog vsquish</span>

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : inverse-probability weights</span>
Outcome model<span class="stres">  : weighted mean</span>
Treatment model<span class="stres">: logit</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -240.2212   24.82773    -9.68   0.000    -288.8826   -191.5597</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3408.235   9.440857   361.01   0.000     3389.732    3426.739</span>
----------------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. * Model for the propensity score (note here the possibility of potential missepecification) </span>
<span class="stinp">. logit $A $W, vce(robust) nolog</span>

Logistic regression                             Number of obs     = <span class="stres">     4,642</span>
                                                Wald chi2(<span class="stres">7</span>)      = <span class="stres">    363.42</span>
                                                Prob &gt; chi2       = <span class="stres">    0.0000</span>
Log pseudolikelihood = <span class="stres">-2026.9688</span>               Pseudo R2         = <span class="stres">    0.0914</span>

------------------------------------------------------------------------------
             |               Robust
     mbsmoke |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">  -1.143264   .1041147   -10.98   0.000    -1.347325   -.9392025</span>
   prenatal1 |<span class="stres">  -.2891671   .0978237    -2.96   0.003    -.4808979   -.0974362</span>
       fbaby |<span class="stres">  -.5087053   .0904202    -5.63   0.000    -.6859256    -.331485</span>
        medu |<span class="stres">  -.1446855    .017873    -8.10   0.000    -.1797159   -.1096551</span>
        mage |<span class="stres">   .0019855   .0086558     0.23   0.819    -.0149795    .0189505</span>
     foreign |<span class="stres">  -1.192764   .2449577    -4.87   0.000    -1.672872   -.7126555</span>
       mrace |<span class="stres">   .5582083   .1190348     4.69   0.000     .3249045    .7915122</span>
       _cons |<span class="stres">   .9735576    .254319     3.83   0.000     .4751015    1.472014</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double ps</span>
(option <span class="stres">pr</span> assumed; Pr(mbsmoke))

<span class="stinp">. </span>
<span class="stinp">. * Sempling weights based on Horvitz-Thompson estimator</span>
<span class="stinp">. generate double ipw1 = ($A==1)/ps</span>

<span class="stinp">. regress $Y [pw=ipw1]</span>
(sum of wgt is 4,506.74922423503)

Linear regression                               Number of obs     = <span class="stres">       864</span>
<span class="stres">                                                </span>F(0, 863)         =  <span class="stres">     0.00</span>
<span class="stres">                                                </span>Prob &gt; F          = <span class="stres">         .</span>
<span class="stres">                                                </span>R-squared         = <span class="stres">    0.0000</span>
<span class="stres">                                                </span>Root MSE          =    <span class="stres"> 571.36</span>

------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |<span class="stres">   3168.014   23.35919   135.62   0.000     3122.167    3213.862</span>
------------------------------------------------------------------------------

<span class="stinp">. generate double ipw0 = ($A==0)/(1-ps)</span>

<span class="stinp">. regress $Y [pw=ipw0]</span>
(sum of wgt is 4,660.13481444053)

Linear regression                               Number of obs     = <span class="stres">     3,778</span>
<span class="stres">                                                </span>F(0, 3777)        =  <span class="stres">     0.00</span>
<span class="stres">                                                </span>Prob &gt; F          = <span class="stres">         .</span>
<span class="stres">                                                </span>R-squared         = <span class="stres">    0.0000</span>
<span class="stres">                                                </span>Root MSE          =    <span class="stres"> 573.51</span>

------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |<span class="stres">   3408.235   9.523029   357.89   0.000     3389.565    3426.906</span>
------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. * Bostrapping to get the SE and 95%CI for the ATE capture program drop ATE</span>
<span class="stinp">. program drop ATE</span>

<span class="stinp">. program define ATE, rclass</span>
  1<span class="stinp">. capture drop y1</span>
  2<span class="stinp">. capture drop y0</span>
  3<span class="stinp">. regress $Y [pw=ipw1]</span>
  4<span class="stinp">. matrix y1 = e(b)</span>
  5<span class="stinp">. gen double y1 = y1[1,1]</span>
  6<span class="stinp">. regress $Y [pw=ipw0]</span>
  7<span class="stinp">. matrix y0 = e(b)</span>
  8<span class="stinp">. gen double y0 = y0[1,1]</span>
  9<span class="stinp">. mean y1 y0</span>
 10<span class="stinp">. lincom _b[y1]-_b[y0]</span>
 11<span class="stinp">. return scalar ace = `r(estimate)'</span>
 12<span class="stinp">. end</span>

<span class="stinp">. qui bootstrap r(ace), reps(1000): ATE</span>

<span class="stinp">. estat boot, all</span>

Bootstrap results                               Number of obs     = <span class="stres">     4,642</span>
                                                Replications      = <span class="stres">      1000</span>

      command:  ATE
        _bs_1:  <span class="stres">r(ace)</span>

------------------------------------------------------------------------------
             |    Observed               Bootstrap
<span class="stres">             </span>|       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _bs_1 |<span class="stres">  -240.22116   .2588013   24.989583   -289.1998  -191.2425</span>   (N)
<span class="stres">             </span>|                                    <span class="stres">  -287.8047  -192.4459</span>   (P)
<span class="stres">             </span>|                                    <span class="stres">  -287.6467  -192.4318</span>  (BC)
------------------------------------------------------------------------------
(N)    normal confidence interval
(P)    percentile confidence interval
(BC)   bias-corrected confidence interval

<span class="stinp">. </span>
<span class="stinp">. // Test balance after adjustment</span>
<span class="stinp">. qui teffects ipw ($Y) ($A $W)   </span>

<span class="stinp">. tebalance summarize</span>

  Covariate balance summary
<span class="stres">                                         </span>          Raw     Weighted
<span class="stres">                          </span>-----------------------------------------
                          Number of obs =<span class="stres">        4,642      4,642.0</span>
<span class="stres">                          </span>Treated obs   =<span class="stres">          864      2,282.2</span>
<span class="stres">                          </span>Control obs   =<span class="stres">        3,778      2,359.8</span>
<span class="stres">                          </span>-----------------------------------------

<span class="stres">  </span>-----------------------------------------------------------------
                  |Standardized differences          Variance ratio
<span class="stres">                  </span>|        Raw    Weighted           Raw   Weighted
<span class="stres">  </span>----------------+------------------------------------------------
         mmarried |<span class="stres">  -.5953009    -.020219      1.335944   1.017057</span>
<span class="stres">  </span>      prenatal1 |<span class="stres">  -.3242695   -.0186635      1.496155     1.0278</span>
<span class="stres">  </span>          fbaby |<span class="stres">  -.1663271    .0217106      .9430944   1.005001</span>
<span class="stres">  </span>           medu |<span class="stres">  -.5474357   -.1156001      .7315846   .5112843</span>
<span class="stres">  </span>           mage |<span class="stres">   -.300179   -.0740731      .8818025   .7979432</span>
<span class="stres">  </span>        foreign |<span class="stres">  -.1706164    -.034976      .4416089   .8643349</span>
<span class="stres">  </span>          mrace |<span class="stres">  -.1029446    -.028183      1.198452   1.052116</span>
<span class="stres">  </span>-----------------------------------------------------------------
</samp></pre>
<h4>Checking positivity violations: Overlap</h4>
<pre id="stlog-12" class="stlog"><samp><span class="stinp">. qui: teffects ipw ($Y) ($A $W, logit), nolog vsquish</span>

<span class="stinp">. teffects overlap</span>
</samp></pre>
<figure id="fig-12">
<figcaption>Figure 1. Probability density function of the propensity score by exposure status</figcaption>
<a href="CIM_12.png"><img alt="CIM_12.png" src="CIM_12.png"/></a>
</figure>
<h4> Overlap by hand</h4>
<pre id="stlog-13" class="stlog"><samp><span class="stinp">. sort $A</span>

<span class="stinp">. by $A: summarize ps</span>

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-&gt; mbsmoke = nonsmoker

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |<span class="stres">      3,778     .169212       .1087   .0102683   .8271439</span>

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-&gt; mbsmoke = smoker

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          ps |<span class="stres">        864    .2600891    .1340289   .0358913   .7831799</span>


<span class="stinp">. kdensity ps if $A==1, generate(x1pointsa d1A) nograph n(10000)</span>
(n() set to 4642)

<span class="stinp">. kdensity ps if $A==0, generate(x0pointsa d0A) nograph n(10000)</span>
(n() set to 4642)

<span class="stinp">. label variable d1A "density for mbsmoke=1"</span>

<span class="stinp">. label variable d0A "density for mbsmoke=0"</span>

<span class="stinp">. twoway (line d0A x0pointsa , yaxis(1))(line d1A x1pointsa, yaxis(2))</span>
</samp></pre>
<figure id="fig-13">
<figcaption>Figure 2. Probability density function of the propensity score by exposure status (hand calculation)</figcaption>
<a href="CIM_13.png"><img alt="CIM_13.png" src="CIM_13.png"/></a>
</figure>
<h3> V) Inverse Probability Weighting plus regression adjustment (IPWRA)</h3>
<pre id="stlog-14" class="stlog"><samp><span class="stinp">. clear</span>

<span class="stinp">. set more off</span>

<span class="stinp">. use http://www.stata-press.com/data/r14/cattaneo2.dta</span>
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

<span class="stinp">. teffects ipwra ($Y $W) ($A $W)</span>

Iteration 0:   EE criterion = <span class="stres"> 1.485e-16</span>  
Iteration 1:   EE criterion = <span class="stres"> 9.421e-25</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : IPW regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: logit</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">   -232.751   26.08798    -8.92   0.000    -283.8825   -181.6195</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3408.781   9.425782   361.64   0.000     3390.307    3427.255</span>
----------------------------------------------------------------------------------------

<span class="stinp">. nlcom 100*_b[r1vs0.mbsmoke]/_b[POmean:0.mbsmoke]</span>

       _nl_1:  <span class="stres">100*_b[r1vs0.mbsmoke]/_b[POmean:0.mbsmoke]</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _nl_1 |<span class="stres">  -6.827984   .7588595    -9.00   0.000    -8.315321   -5.340647</span>
------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. // Step One</span>
<span class="stinp">. * Inverse probability weights</span>
<span class="stinp">. logit $A $W</span>

Iteration 0:   log likelihood = <span class="stres">-2230.7484</span>  
Iteration 1:   log likelihood = <span class="stres">-2039.8238</span>  
Iteration 2:   log likelihood = <span class="stres">-2027.0399</span>  
Iteration 3:   log likelihood = <span class="stres">-2026.9688</span>  
Iteration 4:   log likelihood = <span class="stres">-2026.9688</span>  

Logistic regression                             Number of obs     = <span class="stres">     4,642</span>
                                                LR chi2(<span class="stres">7</span>)        = <span class="stres">    407.56</span>
                                                Prob &gt; chi2       = <span class="stres">    0.0000</span>
Log likelihood = <span class="stres">-2026.9688</span>                     Pseudo R2         = <span class="stres">    0.0914</span>

------------------------------------------------------------------------------
     mbsmoke |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">  -1.143264   .0984479   -11.61   0.000    -1.336218   -.9503091</span>
   prenatal1 |<span class="stres">  -.2891671   .0967775    -2.99   0.003    -.4788476   -.0994866</span>
       fbaby |<span class="stres">  -.5087053    .089107    -5.71   0.000    -.6833518   -.3340587</span>
        medu |<span class="stres">  -.1446855   .0178536    -8.10   0.000    -.1796779   -.1096932</span>
        mage |<span class="stres">   .0019855   .0085171     0.23   0.816    -.0147077    .0186787</span>
     foreign |<span class="stres">  -1.192764   .2434403    -4.90   0.000    -1.669898   -.7156296</span>
       mrace |<span class="stres">   .5582083   .1153203     4.84   0.000     .3321848    .7842319</span>
       _cons |<span class="stres">   .9735576   .2573016     3.78   0.000     .4692559    1.477859</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double dps, pr</span>

<span class="stinp">. gen ipw = .</span>
(4,642 missing values generated)

<span class="stinp">. replace ipw=($A==1)/dps if $A==1</span>
(864 real changes made)

<span class="stinp">. replace ipw=($A==0)/(1-dps) if $A==0</span>
(3,778 real changes made)

<span class="stinp">. sum ipw </span>

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         ipw |<span class="stres">      4,642     1.97477    2.119163   1.010375   27.86188</span>

<span class="stinp">. </span>
<span class="stinp">. * Stabilized weights</span>
<span class="stinp">. logit $A, vce(robust) nolog</span>

Logistic regression                             Number of obs     = <span class="stres">     4,642</span>
                                                Wald chi2(0)      =          <span class="stres">.</span>
                                                Prob &gt; chi2       =          <span class="stres">.</span>
Log pseudolikelihood = <span class="stres">-2230.7484</span>               Pseudo R2         = <span class="stres">    0.0000</span>

------------------------------------------------------------------------------
             |               Robust
     mbsmoke |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _cons |<span class="stres">  -1.475377   .0377148   -39.12   0.000    -1.549297   -1.401458</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double nps, pr</span>

<span class="stinp">. gen sws = .</span>
(4,642 missing values generated)

<span class="stinp">. replace sws = nps/dps if $A==1</span>
(864 real changes made)

<span class="stinp">. replace sws = (1-nps)/(1-dps) if $A==0</span>
(3,778 real changes made)

<span class="stinp">. sum sws</span>

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         sws |<span class="stres">      4,642    .9977565    .3239543   .2376551   5.185839</span>

<span class="stinp">. </span>
<span class="stinp">. // Step Two</span>
<span class="stinp">. * GCOMP</span>
<span class="stinp">. reg $Y $W if $A==1 [pw=sws]</span>
(sum of wgt is 838.8262244164944)

Linear regression                               Number of obs     = <span class="stres">       864</span>
<span class="stres">                                                </span>F(7, 856)         =  <span class="stres">     3.88</span>
<span class="stres">                                                </span>Prob &gt; F          = <span class="stres">    0.0004</span>
<span class="stres">                                                </span>R-squared         = <span class="stres">    0.0411</span>
<span class="stres">                                                </span>Root MSE          =    <span class="stres"> 561.78</span>

------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">   65.34198   45.13777     1.45   0.148    -23.25169    153.9356</span>
   prenatal1 |<span class="stres">  -7.480862   46.30099    -0.16   0.872    -98.35762     83.3959</span>
       fbaby |<span class="stres">   40.47876   49.47901     0.82   0.414    -56.63562    137.5932</span>
        medu |<span class="stres">   21.12795   11.91467     1.77   0.077    -2.257435    44.51334</span>
        mage |<span class="stres">  -8.216456   5.313706    -1.55   0.122    -18.64588    2.212963</span>
     foreign |<span class="stres">    201.832   140.7535     1.43   0.152    -74.43046    478.0945</span>
       mrace |<span class="stres">    211.021   65.76906     3.21   0.001     81.93349    340.1085</span>
       _cons |<span class="stres">   2880.082   183.0892    15.73   0.000     2520.725    3239.438</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double y1, xb</span>

<span class="stinp">. reg $Y $W if $A==0 [pw=sws]</span>
(sum of wgt is 3,792.75944876671)

Linear regression                               Number of obs     = <span class="stres">     3,778</span>
<span class="stres">                                                </span>F(7, 3770)        =  <span class="stres">    25.82</span>
<span class="stres">                                                </span>Prob &gt; F          = <span class="stres">    0.0000</span>
<span class="stres">                                                </span>R-squared         = <span class="stres">    0.0607</span>
<span class="stres">                                                </span>Root MSE          =    <span class="stres"> 556.35</span>

------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    mmarried |<span class="stres">   54.60708   27.87333     1.96   0.050    -.0411953    109.2553</span>
   prenatal1 |<span class="stres">   25.72218   27.33137     0.94   0.347    -27.86353    79.30789</span>
       fbaby |<span class="stres">  -89.76871    20.5927    -4.36   0.000    -130.1426    -49.3948</span>
        medu |<span class="stres">   1.077116   3.674251     0.29   0.769    -6.126596    8.280828</span>
        mage |<span class="stres">   3.183998   2.198838     1.45   0.148    -1.127029    7.495025</span>
     foreign |<span class="stres">  -32.60431   40.10512    -0.81   0.416    -111.2341    46.02552</span>
       mrace |<span class="stres">   295.4244   33.41343     8.84   0.000     229.9142    360.9345</span>
       _cons |<span class="stres">   3044.628   62.32354    48.85   0.000     2922.437    3166.819</span>
------------------------------------------------------------------------------

<span class="stinp">. predict double y0, xb </span>

<span class="stinp">. mean y1 y0</span>

Mean estimation                   Number of obs   = <span class="stres">     4,642</span>

--------------------------------------------------------------
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
          y1 |<span class="stres">    3176.03   1.698071      3172.701    3179.359</span>
          y0 |<span class="stres">   3408.781   2.041572      3404.779    3412.784</span>
--------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. *IPWRA (Problem SE) we need bootstrap</span>
<span class="stinp">. nlcom(_b[y1]-_b[y0])</span>

       _nl_1:  <span class="stres">_b[y1]-_b[y0]</span>

------------------------------------------------------------------------------
        Mean |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _nl_1 |<span class="stres">   -232.751   1.757386  -132.44   0.000    -236.1954   -229.3066</span>
------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. *Bostrapping SE ATE (Stabilized weights)</span>
<span class="stinp">. capture program drop ACE</span>

<span class="stinp">. program define ACE, rclass</span>
  1<span class="stinp">. capture drop y1</span>
  2<span class="stinp">. capture drop y0</span>
  3<span class="stinp">. reg $Y $W if $A==1 [pw=sws]</span>
  4<span class="stinp">. predict double y1, xb</span>
  5<span class="stinp">. quiet sum y1</span>
  6<span class="stinp">. return scalar y1=`r(mean)'</span>
  7<span class="stinp">. reg $Y $W if $A==0 [pw=sws]</span>
  8<span class="stinp">. predict double y0, xb </span>
  9<span class="stinp">. quiet sum y0</span>
 10<span class="stinp">. return scalar y0=`r(mean)'</span>
 11<span class="stinp">. mean y1 y0 </span>
 12<span class="stinp">. lincom _b[y1]-_b[y0]</span>
 13<span class="stinp">. return scalar ace =`r(estimate)'</span>
 14<span class="stinp">. end</span>

<span class="stinp">. qui bootstrap r(ace), reps(1000): ACE</span>

<span class="stinp">. estat boot, all</span>

Bootstrap results                               Number of obs     = <span class="stres">     4,642</span>
                                                Replications      = <span class="stres">      1000</span>

      command:  ACE
        _bs_1:  <span class="stres">r(ace)</span>

------------------------------------------------------------------------------
             |    Observed               Bootstrap
<span class="stres">             </span>|       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _bs_1 |<span class="stres">  -232.75103  -1.746588   26.592008   -284.8704  -180.6317</span>   (N)
<span class="stres">             </span>|                                    <span class="stres">  -287.9317  -181.1544</span>   (P)
<span class="stres">             </span>|                                    <span class="stres">  -284.0648  -178.2514</span>  (BC)
------------------------------------------------------------------------------
(N)    normal confidence interval
(P)    percentile confidence interval
(BC)   bias-corrected confidence interval

<span class="stinp">. </span>
<span class="stinp">. teffects ipwra ($Y $W) ($A $W)</span>

Iteration 0:   EE criterion = <span class="stres"> 1.485e-16</span>  
Iteration 1:   EE criterion = <span class="stres"> 9.421e-25</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : IPW regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: logit</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">   -232.751   26.08798    -8.92   0.000    -283.8825   -181.6195</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3408.781   9.425782   361.64   0.000     3390.307    3427.255</span>
----------------------------------------------------------------------------------------
</samp></pre>
<h3> VI) Augmented Inverse Probability Weighting plus regression adjustment (IPWRA)</h3>
<pre id="stlog-15" class="stlog"><samp><span class="stinp">. // Stata AIPW implementation</span>
<span class="stinp">. clear</span>

<span class="stinp">. set more off</span>

<span class="stinp">. use http://www.stata-press.com/data/r14/cattaneo2.dta</span>
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

<span class="stinp">. teffects aipw ($Y $W) ($A $W, logit)</span>

Iteration 0:   EE criterion = <span class="stres"> 1.485e-16</span>  
Iteration 1:   EE criterion = <span class="stres"> 5.017e-25</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     4,642</span>
Estimator<span class="stres">      : augmented IPW</span>
Outcome model<span class="stres">  : linear by ML</span>
Treatment model<span class="stres">: logit</span>
----------------------------------------------------------------------------------------
                       |               Robust
               bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
<span class="stres">ATE                    </span>|
               mbsmoke |
(smoker vs nonsmoker)  |<span class="stres">  -237.5415   25.66737    -9.25   0.000    -287.8486   -187.2344</span>
-----------------------+----------------------------------------------------------------
<span class="stres">POmean                 </span>|
               mbsmoke |
            nonsmoker  |<span class="stres">   3409.018   9.421793   361.82   0.000     3390.552    3427.484</span>
----------------------------------------------------------------------------------------

<span class="stinp">. nlcom 100*_b[r1vs0.mbsmoke]/_b[POmean:0.mbsmoke]</span>

       _nl_1:  <span class="stres">100*_b[r1vs0.mbsmoke]/_b[POmean:0.mbsmoke]</span>

------------------------------------------------------------------------------
     bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _nl_1 |<span class="stres">  -6.968033   .7462114    -9.34   0.000    -8.430581   -5.505486</span>
------------------------------------------------------------------------------

<span class="stinp">. </span>
<span class="stinp">. // AIPTW implementation</span>
<span class="stinp">. qui sum $Y</span>

<span class="stinp">. gen double Y = ($Y -`r(min)')/(`r(max)' - `r(min)')</span>

<span class="stinp">. qui sum $Y </span>

<span class="stinp">. global cf = (`r(max)' - `r(min)')</span>

<span class="stinp">. * Step 1: prediction model for the outcome Q0 (g-computation)</span>
<span class="stinp">. qui glm Y $A $W, fam(bin) </span>

<span class="stinp">. predict double QAW, xb</span>

<span class="stinp">. qui glm Y $W if $A==1, fam(bin) </span>

<span class="stinp">. predict double Q1W, mu</span>

<span class="stinp">. qui glm Y $W if $A==0, fam(bin)</span>

<span class="stinp">. predict double Q0W, mu</span>

<span class="stinp">. </span>
<span class="stinp">. * Step 2: prediction model for the treatment g0 (IPTW)</span>
<span class="stinp">. * Inverse probability weights (Stabilized weights)</span>
<span class="stinp">. qui logit $A $W</span>

<span class="stinp">. predict double dps, pr</span>

<span class="stinp">. * Stabilized weights</span>
<span class="stinp">. qui logit $A</span>

<span class="stinp">. predict double nps, pr</span>

<span class="stinp">. gen sws = .</span>
(4,642 missing values generated)

<span class="stinp">. replace sws = nps/dps if $A==1</span>
(864 real changes made)

<span class="stinp">. replace sws = (1-nps)/(1-dps) if $A==0</span>
(3,778 real changes made)

<span class="stinp">. sum sws</span>

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         sws |<span class="stres">      4,642    .9977565    .3239543   .2376551   5.185839</span>

<span class="stinp">. </span>
<span class="stinp">. * Step 3: Estimation Equation</span>
<span class="stinp">. gen double ATE = (sws*(Y-QAW) + (Q1W - Q0W)*$cf)</span>

<span class="stinp">. sum ATE</span>

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         ATE |<span class="stres">      4,642   -238.8908    106.5089  -487.0504   195.8233</span>

<span class="stinp">. * Marginal Structural Model </span>
<span class="stinp">. glm $Y $A [pw=sws],nolog</span>

Generalized linear models                         No. of obs      = <span class="stres">     4,642</span>
Optimization     : <span class="stres">ML</span>                             Residual df     = <span class="stres">     4,640</span>
<span class="stres">                   </span>                               Scale parameter =  <span class="stres"> 327735.3</span>
Deviance         =<span class="stres">   1520691611</span>                   (1/df) Deviance =<span class="stres">   327735.3</span>
Pearson          =<span class="stres">   1520691611</span>                   (1/df) Pearson  =<span class="stres">   327735.3</span>

Variance function: <span class="stres">V(u) = 1                       </span>[<span class="stres">Gaussian</span>]
Link function    : <span class="stres">g(u) = u                       </span>[<span class="stres">Identity</span>]

                                                  AIC             =<span class="stres">   15.50565</span>
Log pseudolikelihood = <span class="stres">-35986.62428</span>               BIC             =<span class="stres">   1.52e+09</span>

------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |<span class="stres">  -240.2212    25.2155    -9.53   0.000    -289.6426   -190.7997</span>
       _cons |<span class="stres">   3408.235   9.522794   357.90   0.000     3389.571      3426.9</span>
------------------------------------------------------------------------------
</samp></pre>
<h3> INTERESTING: Look at the 95%CI for the AIPTW estimator using BOOTSTRAP!!</h3>
<pre id="stlog-16" class="stlog"><samp><span class="stinp">. drop ATE</span>

<span class="stinp">. capture program drop ACE</span>

<span class="stinp">. program define ACE, rclass</span>
  1<span class="stinp">. capture drop ATE</span>
  2<span class="stinp">. * Estimation Equation</span>
<span class="stinp">. gen double ATE = (sws*(Y-QAW) + (Q1W - Q0W)*$cf)</span>
  3<span class="stinp">. mean ATE</span>
  4<span class="stinp">. lincom _b[ATE]</span>
  5<span class="stinp">. return scalar ace =`r(estimate)'</span>
  6<span class="stinp">. end</span>

<span class="stinp">. qui bootstrap r(ace), reps(1000): ACE</span>

<span class="stinp">. estat boot, all</span>

Bootstrap results                               Number of obs     = <span class="stres">     4,642</span>
                                                Replications      = <span class="stres">      1000</span>

      command:  ACE
        _bs_1:  <span class="stres">r(ace)</span>

------------------------------------------------------------------------------
             |    Observed               Bootstrap
<span class="stres">             </span>|       Coef.       Bias    Std. Err.  [95% Conf. Interval]
-------------+----------------------------------------------------------------
       _bs_1 |<span class="stres">  -238.89079   .0292854   1.5841525   -241.9957  -235.7859</span>   (N)
<span class="stres">             </span>|                                    <span class="stres">  -241.9429  -235.7569</span>   (P)
<span class="stres">             </span>|                                    <span class="stres">  -241.9064  -235.7392</span>  (BC)
------------------------------------------------------------------------------
(N)    normal confidence interval
(P)    percentile confidence interval
(BC)   bias-corrected confidence interval
</samp></pre>
<h3> VII) Ensemble Learning Targeted Maximum Likelihood Estimation </h3>
<pre id="stlog-17" class="stlog"><samp><span class="stinp">. eltmle $Y $A $W, tmle</span>
<span class="stres">D:\Dropbox\CAUSALITY\BOX\ShortCourseGranada\My-STATA-FILES</span>

<span class="stinp">. shell "C:\Program Files\R\R-3.3.2\bin\x64\R.exe" CMD BATCH SLS.R </span>

<span class="stinp">. </span>
end of do-file

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        POM1 |<span class="stres">      4,642    2839.505     111.259   2355.208   3111.317</span>
        POM0 |<span class="stres">      4,642    3065.963    132.7883   2589.092   3202.195</span>
          WT |<span class="stres">      4,642    -.044143    2.959656  -6.186227   32.51731</span>
          PS |<span class="stres">      4,642    .1863172    .1229295       .025   .8383506</span>


<span class="stres">ACE (Additive Effect): -226.4587; Estimated Variance:  625.9183; p-value: 0.0000; 95%CI:( -275.49,  -177.42)</span>


<span class="stres">ACE (Risk Differences):   -0.0439; SE:   0.00485; p-value: 0.0000; 95%CI:(-0.0534,-0.0344)</span>
</samp></pre>
<h3> VII) SIMULATION </h3>
<h3> DATA GENERATION </h3>
<p>w1=Socieconomic status, w2=Age, w3=Cancer stage, w4=Comorbidities</p>
<p>Note: the interaction between age and comorbidities</p>
<pre id="stlog-18" class="stlog"><samp><span class="stinp">. clear</span>

<span class="stinp">. set obs 1000</span>
number of observations (_N) was 0, now 1,000

<span class="stinp">. set seed 777</span>

<span class="stinp">. gen w1    = round(runiform(1, 5)) <span class="stcmt">//Quintiles of Socioeconomic Deprivation</span></span>

<span class="stinp">. gen w2    = rbinomial(1, 0.45) <span class="stcmt">//Binary: probability age &gt;65 = 0.45</span></span>

<span class="stinp">. gen w3    = round(runiform(0, 1) + 0.75*(w2) + 0.8*(w1)) <span class="stcmt">//Stage </span></span>

<span class="stinp">. recode w3 (5/6=1)       <span class="stcmt">//Stage (TNM): categorical 4 levels</span></span>
(w3: 128 changes made)

<span class="stinp">. gen w4    = round(runiform(0, 1) + 0.75*(w2) + 0.2*(w1)) <span class="stcmt">//Comorbidites: categorical four levels</span></span>

<span class="stinp">. gen A     = (rbinomial(1,invlogit(-1 -  0.15*(w4) + 1.5*(w2) + 0.75*(w3) + 0.25*(w1) + 0.8*(w2)*(w4)))) <span class="stcmt">//Binary treatment</span></span>

<span class="stinp">. gen Y     = (rbinomial(1,invlogit(-3 + A + 0.25*(w4) + 0.75*(w3) + 0.8*(w2)*(w4) + 0.05*(w1)))) <span class="stcmt">//Binary outcome</span></span>

<span class="stinp">. // Potential outcomes</span>
<span class="stinp">. gen Yt1 = (invlogit(-3 + 1 + 0.25*(w4) + 0.75*(w3) + 0.8*(w2)*(w4) + 0.05*(w1)))</span>

<span class="stinp">. gen Yt0 = (invlogit(-3 + 0 + 0.25*(w4) + 0.75*(w3) + 0.8*(w2)*(w4) + 0.05*(w1)))</span>

<span class="stinp">. // True ATE</span>
<span class="stinp">. gen psi = Yt1-Yt0</span>
</samp></pre>
<p>TRUE SIMULATED ATE = 17.8%</p>
<pre id="stlog-19" class="stlog"><samp><span class="stinp">. mean psi</span>

Mean estimation                   Number of obs   = <span class="stres">     1,000</span>

--------------------------------------------------------------
             |       Mean   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
         psi |<span class="stres">   .1787412   .0020142      .1747886    .1826938</span>
--------------------------------------------------------------
</samp></pre>
<h3>II) ATE estimation</h3>
<p>Note: We misspecified the models excluding the interaction between age and comorbidities</p>
<p>Regression adjustment ATE = 24.1%</p>
<pre id="stlog-20" class="stlog"><samp><span class="stinp">. teffects ra (Y w1 w2 w3 w4) (A)</span>

Iteration 0:   EE criterion = <span class="stres"> 8.701e-32</span>  
Iteration 1:   EE criterion = <span class="stres"> 1.434e-32</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     1,000</span>
Estimator<span class="stres">      : regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: none</span>
------------------------------------------------------------------------------
             |               Robust
           Y |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">ATE          </span>|
           A |
   (1 vs 0)  |<span class="stres">   .2410504   .1148066     2.10   0.036     .0160336    .4660672</span>
-------------+----------------------------------------------------------------
<span class="stres">POmean       </span>|
           A |
          0  |<span class="stres">   .4739475   .1141366     4.15   0.000     .2502439     .697651</span>
------------------------------------------------------------------------------

<span class="stinp">. estimates store ra</span>
</samp></pre>
<p>Inverse probability weighting ATE = 37.9%</p>
<pre id="stlog-21" class="stlog"><samp><span class="stinp">. teffects ipw (Y) (A w1 w2 w3 w4) </span>

Iteration 0:   EE criterion = <span class="stres"> 3.522e-23</span>  
Iteration 1:   EE criterion = <span class="stres"> 2.840e-33</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     1,000</span>
Estimator<span class="stres">      : inverse-probability weights</span>
Outcome model<span class="stres">  : weighted mean</span>
Treatment model<span class="stres">: logit</span>
------------------------------------------------------------------------------
             |               Robust
           Y |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">ATE          </span>|
           A |
   (1 vs 0)  |<span class="stres">    .378604   .0807516     4.69   0.000     .2203337    .5368743</span>
-------------+----------------------------------------------------------------
<span class="stres">POmean       </span>|
           A |
          0  |<span class="stres">   .3362695    .079327     4.24   0.000     .1807913    .4917476</span>
------------------------------------------------------------------------------

<span class="stinp">. estimates store ipw</span>
</samp></pre>
<p>IPTW-RA ATE = 31.9%</p>
<pre id="stlog-22" class="stlog"><samp><span class="stinp">. teffects ipwra (Y w1 w2 w3 w4) (A w1 w2 w3 w4)</span>

Iteration 0:   EE criterion = <span class="stres"> 3.522e-23</span>  
Iteration 1:   EE criterion = <span class="stres"> 5.128e-33</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     1,000</span>
Estimator<span class="stres">      : IPW regression adjustment</span>
Outcome model<span class="stres">  : linear</span>
Treatment model<span class="stres">: logit</span>
------------------------------------------------------------------------------
             |               Robust
           Y |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">ATE          </span>|
           A |
   (1 vs 0)  |<span class="stres">   .3188398   .0706036     4.52   0.000     .1804593    .4572202</span>
-------------+----------------------------------------------------------------
<span class="stres">POmean       </span>|
           A |
          0  |<span class="stres">   .3958477   .0691749     5.72   0.000     .2602674    .5314281</span>
------------------------------------------------------------------------------

<span class="stinp">. estimates store ipwra</span>
</samp></pre>
<p>AIPTW ATE = 28.8%</p>
<pre id="stlog-23" class="stlog"><samp><span class="stinp">. teffects aipw (Y w1 w2 w3 w4) (A w1 w2 w3 w4)</span>

Iteration 0:   EE criterion = <span class="stres"> 3.522e-23</span>  
Iteration 1:   EE criterion = <span class="stres"> 3.600e-33</span>  

Treatment-effects estimation                    Number of obs     = <span class="stres">     1,000</span>
Estimator<span class="stres">      : augmented IPW</span>
Outcome model<span class="stres">  : linear by ML</span>
Treatment model<span class="stres">: logit</span>
------------------------------------------------------------------------------
             |               Robust
           Y |      Coef.   Std. Err.      z    P&gt;|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
<span class="stres">ATE          </span>|
           A |
   (1 vs 0)  |<span class="stres">    .285314   .1152551     2.48   0.013     .0594183    .5112098</span>
-------------+----------------------------------------------------------------
<span class="stres">POmean       </span>|
           A |
          0  |<span class="stres">   .4293636   .1144905     3.75   0.000     .2049664    .6537608</span>
------------------------------------------------------------------------------

<span class="stinp">. estimates store aipw</span>
</samp></pre>
<h3>III) RESULTS</h3>
<pre id="stlog-24" class="stlog"><samp><span class="stinp">. quie reg psi</span>

<span class="stinp">. estimates store psi</span>

<span class="stinp">. estout psi ra ipw ipwra aipw</span>

-----------------------------------------------------------------------------
                      psi           ra          ipw        ipwra         aipw
                        b            b            b            b            b
-----------------------------------------------------------------------------
<span class="stres">main                                                                         </span>
r1vs0.A     <span class="stres">                  .2410504      .378604     .3188398      .285314</span>
_cons       <span class="stres">     .1787412                                                    </span>
-----------------------------------------------------------------------------
<span class="stres">POmean                                                                       </span>
0.A         <span class="stres">                  .4739475     .3362695     .3958477     .4293636</span>
-----------------------------------------------------------------------------
<span class="stres">OME0                                                                         </span>
w1          <span class="stres">                  .0395478                  .1119125     .0395478</span>
w2          <span class="stres">                  .1770299                  -.098543     .1770299</span>
w3          <span class="stres">                  .1715455                  .0389883     .1715455</span>
w4          <span class="stres">                  .1019039                  .2425232     .1019039</span>
_cons       <span class="stres">                 -.3331923                 -.3427923    -.3331923</span>
-----------------------------------------------------------------------------
<span class="stres">OME1                                                                         </span>
w1          <span class="stres">                  .0100658                  .0071447     .0100658</span>
w2          <span class="stres">                  .1529128                  .1510302     .1529128</span>
w3          <span class="stres">                  .0867786                  .0859272     .0867786</span>
w4          <span class="stres">                  .1157346                  .1193923     .1157346</span>
_cons       <span class="stres">                  .2148979                  .2211646     .2148979</span>
-----------------------------------------------------------------------------
<span class="stres">TME1                                                                         </span>
w1          <span class="stres">                                .200913      .200913      .200913</span>
w2          <span class="stres">                               3.383105     3.383105     3.383105</span>
w3          <span class="stres">                               .6876172     .6876172     .6876172</span>
w4          <span class="stres">                              -.1261434    -.1261434    -.1261434</span>
_cons       <span class="stres">                                -.85242      -.85242      -.85242</span>
-----------------------------------------------------------------------------
</samp></pre>
<p>Ensemble Learning Maximum Likelihood Estimation (ELTMLE) ATE = 22.1%</p>
<pre id="stlog-25" class="stlog"><samp><span class="stinp">. eltmle Y A w1 w2 w3 w4, tmle</span>
<span class="stres">D:\Dropbox\CAUSALITY\BOX\ShortCourseGranada\My-STATA-FILES</span>

<span class="stinp">. shell "C:\Program Files\R\R-3.3.2\bin\x64\R.exe" CMD BATCH SLS.R </span>

<span class="stinp">. </span>
end of do-file

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
        POM1 |<span class="stres">      1,000    .7100199     .187985     .20515   .9727612</span>
        POM0 |<span class="stres">      1,000    .4891232     .255392   .0454817   .9379262</span>
          WT |<span class="stres">      1,000    .2563642    3.599528        -40   2.046998</span>
          PS |<span class="stres">      1,000      .86845    .1383139   .4885203       .975</span>


<span class="stres">TMLE: Average Causal Effect</span>

<span class="stres">ACE (Risk Differences):    0.2209; SE:   0.05458; p-value: 0.0002; 95%CI:(0.1139, 0.3279)</span>


<span class="stres">TMLE: Causal Relative Risk</span>

<span class="stres">RR:   1.4516; 95%CI:(1.1314, 1.8624)</span>
</samp></pre>
<p>RELATIVE BIAS IPTW</p>
<pre id="stlog-26" class="stlog"><samp><span class="stinp">. display (0.38 - 0.18)/.38 </span>
<span class="stres">.52631579</span>
</samp></pre>
<p>RELATIVE BIAS AIPTW</p>
<pre id="stlog-27" class="stlog"><samp><span class="stinp">. display (0.28 - 0.18)/0.28</span>
<span class="stres">.35714286</span>
</samp></pre>
<p>RELATIVE BIAS ELTMLE</p>
<pre id="stlog-28" class="stlog"><samp><span class="stinp">. display (0.22 - 0.18)/0.22</span>
<span class="stres">.18181818</span>
</samp></pre>
<h3> Appendix: ELTMLE programme </h3>
<pre id="stlog-29" class="stlog"><samp><span class="stinp">. *! version 2.2.1  30.Jun.2017</span>
<span class="stinp">. *! ELTMLE: Stata module for Ensemble Learning Targeted Maximum Likelihood Estimation</span>
<span class="stinp">. *! by Miguel Angel Luque-Fernandez [cre,aut]</span>
<span class="stinp">. *! Bug reports:</span>
<span class="stinp">. *! miguel-angel.luque at lshtm.ac.uk</span>
<span class="stinp">. </span>
<span class="stinp">. /<span class="stcmt">*</span>
&gt; Copyright (c) 2017  &lt;Miguel Angel Luque-Fernandez&gt;
&gt; 
&gt; Permission is hereby granted, free of charge, to any person obtaining a copy
&gt; of this software and associated documentation files (the "Software"), to deal
&gt; in the Software without restriction, including without limitation the rights
&gt; to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
&gt; copies of the Software, and to permit persons to whom the Software is
&gt; furnished to do so, subject to the following conditions:
&gt; 
&gt; The above copyright notice and this permission notice shall be included in
&gt; all copies or substantial portions of the Software.
&gt; 
&gt; THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
&gt; IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
&gt; FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
&gt; AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
&gt; LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
&gt; OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
&gt; THE SOFTWARE.
&gt; */</span>
<span class="stinp">. </span>
<span class="stinp">. <span class="stcmt">***************************************************************************</span></span>
<span class="stinp">. <span class="stcmt">** MIGUEL ANGEL LUQUE FERNANDEZ</span></span>
<span class="stinp">. <span class="stcmt">** mluquefe@hsph.havard.edu // miguel-angel.luque@lshtm.ac.uk</span></span>
<span class="stinp">. <span class="stcmt">** TMLE ALGORITHM IMPLEMENTATION IN STATA FOR BINARY OR CONTINUOUS </span></span>
<span class="stinp">. <span class="stcmt">** OUTCOME AND BINARY TREATMENT FOR WINDOWS USERS </span></span>
<span class="stinp">. <span class="stcmt">** Improved AIPTW with Super Learner (Ensemble Learning)</span></span>
<span class="stinp">. <span class="stcmt">** This program requires R to be installed in your computer</span></span>
<span class="stinp">. <span class="stcmt">** JUNE 2017</span></span>
<span class="stinp">. <span class="stcmt">****************************************************************************</span></span>
<span class="stinp">. </span>
<span class="stinp">. * Improved Imfluence curve estimation for the causal relative risk</span>
<span class="stinp">. * Improved display including potential outcomes and weights to check balance</span>
<span class="stinp">. * Included estimation for continuous outcomes </span>
<span class="stinp">. * Added additive causal effects for continuous outcome</span>
<span class="stinp">. * Fixed risk difference and causal relative risk for SLAIPW and SLAIPWBGAM </span>
<span class="stinp">. * Checked consistency of confidence intervals for RR</span>
<span class="stinp">. </span>
<span class="stinp">. capture program drop eltmle</span>

<span class="stinp">. program define eltmle</span>
  1<span class="stinp">.      syntax varlist(min=3) [if] [pw] [, slaipw slaipwbgam tmle tmlebgam] </span>
  2<span class="stinp">.          version 13.2</span>
  3<span class="stinp">.          marksample touse</span>
  4<span class="stinp">.          local var `varlist' if `touse'</span>
  5<span class="stinp">.          tokenize `var'</span>
  6<span class="stinp">.          local yvar = "`1'" </span>
  7<span class="stinp">.      global flag = cond(`yvar'&lt;=1,1,0)</span>
  8<span class="stinp">.          qui sum `yvar'</span>
  9<span class="stinp">.          global b = `r(max)'</span>
 10<span class="stinp">.          global a = `r(min)'</span>
 11<span class="stinp">.          qui replace `yvar' = (`yvar' - `r(min)') / (`r(max)' - `r(min)') if `yvar'&gt;1</span>
 12<span class="stinp">.      local dir `c(pwd)'</span>
 13<span class="stinp">.          cd "`dir'"</span>
 14<span class="stinp">.          qui export delimited `var' using "data.csv", nolabel replace </span>
 15<span class="stinp">.          if "`slaipw'" == "" &amp; "`slaipwbgam'" == "" &amp; "`tmlebgam'" == "" {</span>
 16<span class="stinp">.                 tmle `varlist'</span>
 17<span class="stinp">.          }</span>
 18<span class="stinp">.          else if "`tmlebgam'" == "tmlebgam" {</span>
 19<span class="stinp">.                 tmlebgam `varlist'</span>
 20<span class="stinp">.          }</span>
 21<span class="stinp">.          else if "`slaipw'" == "slaipw" { </span>
 22<span class="stinp">.             slaipw `varlist'</span>
 23<span class="stinp">.          }</span>
 24<span class="stinp">.          else if "`slaipwbgam'" == "slaipwbgam" {</span>
 25<span class="stinp">.                 slaipwbgam `varlist'</span>
 26<span class="stinp">.          }</span>
 27<span class="stinp">. end </span>

<span class="stinp">. </span>
<span class="stinp">. program tmle  </span>
  1<span class="stinp">. // Write R Code dependencies: foreign Surperlearner </span>
<span class="stinp">. set more off</span>
  2<span class="stinp">. qui: file close _all</span>
  3<span class="stinp">. qui: file open rcode using SLS.R, write replace</span>
  4<span class="stinp">. qui: file write rcode <span class="stcmt">///</span>
&gt;         `"set.seed(123)"' _newline <span class="stcmt">///</span>
&gt;         `"list.of.packages &lt;- c("foreign","SuperLearner")"' _newline <span class="stcmt">///</span>
&gt;         `"new.packages &lt;- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]"' _newline <span class="stcmt">///</span>
&gt;         `"if(length(new.packages)) install.packages(new.packages, repos='http://cran.us.r-project.org')"' _newline <span class="stcmt">///</span>
&gt;         `"library(SuperLearner)"' _newline <span class="stcmt">///</span>
&gt;         `"library(foreign)"' _newline <span class="stcmt">///</span>
&gt;         `"data &lt;- read.csv("data.csv", sep=",")"' _newline <span class="stcmt">///</span>
&gt;         `"attach(data)"' _newline <span class="stcmt">///</span>
&gt;         `"SL.library &lt;- c("SL.glm","SL.step","SL.glm.interaction")"' _newline <span class="stcmt">///</span>
&gt;         `"n &lt;- nrow(data)"' _newline <span class="stcmt">///</span>
&gt;         `"nvar &lt;- dim(data)[[2]]"' _newline <span class="stcmt">///</span>
&gt;         `"Y &lt;- data[,1]"' _newline <span class="stcmt">///</span>
&gt;         `"A &lt;- data[,2]"' _newline <span class="stcmt">///</span>
&gt;         `"X &lt;- data[,2:nvar]"' _newline <span class="stcmt">///</span>
&gt;         `"W &lt;- data[,3:nvar]"' _newline <span class="stcmt">///</span>
&gt;         `"X1 &lt;- X0 &lt;- X"' _newline <span class="stcmt">/// </span>
&gt;         `"X1[,1] &lt;- 1"' _newline <span class="stcmt">///</span>
&gt;         `"X0[,1] &lt;- 0"' _newline <span class="stcmt">///</span>
&gt;         `"newdata &lt;- rbind(X,X1,X0)"' _newline <span class="stcmt">/// </span>
&gt;         `"Q &lt;- try(SuperLearner(Y = data[,1] ,X = X, SL.library=SL.library, family=binomial(), newX=newdata, method="method.NNLS"), silent=TRUE)"' _newline <span class="stcmt">///</span>
&gt;         `"Q &lt;- as.data.frame(Q[[4]])"' _newline <span class="stcmt">///</span>
&gt;         `"QAW &lt;- Q[1:n,]"' _newline <span class="stcmt">///</span>
&gt;         `"Q1W &lt;- Q[((n+1):(2*n)),]"' _newline <span class="stcmt">///</span>
&gt;         `"Q0W &lt;- Q[((2*n+1):(3*n)),]"' _newline <span class="stcmt">///</span>
&gt;         `"g &lt;- suppressWarnings(SuperLearner(Y = data[,2], X = W, SL.library = SL.library, family = binomial(), method = "method.NNLS"))"' _newline <span class="stcmt">///</span>
&gt;         `"ps &lt;- g[[4]]"' _newline <span class="stcmt">///</span>
&gt;         `"ps[ps&lt;0.025] &lt;- 0.025"' _newline <span class="stcmt">///</span>
&gt;         `"ps[ps&gt;0.975] &lt;- 0.975"' _newline <span class="stcmt">///</span>
&gt;         `"data &lt;- cbind(data,QAW,Q1W,Q0W,ps,Y,A)"' _newline <span class="stcmt">///</span>
&gt;         `"write.dta(data, "data2.dta")"'  </span>
  5<span class="stinp">. qui: file close rcode</span>
  6<span class="stinp">. </span>
<span class="stinp">. // Write bacth file to find R.exe path and R version</span>
<span class="stinp">. set more off</span>
  7<span class="stinp">. qui: file close _all</span>
  8<span class="stinp">. qui: file open bat using setup.bat, write replace</span>
  9<span class="stinp">. qui: file write bat <span class="stcmt">///</span>
&gt; `"@echo off"' _newline <span class="stcmt">///</span>
&gt; `"SET PATHROOT=C:\Program Files\R\"' _newline <span class="stcmt">///</span>
&gt; `"echo Locating path of R..."' _newline <span class="stcmt">///</span>
&gt; `"echo."' _newline <span class="stcmt">///</span>
&gt; `"if not exist "%PATHROOT%" goto:NO_R"' _newline <span class="stcmt">///</span>
&gt; `"for /f "delims=" %%r in (' dir /b "%PATHROOT%R*" ') do ("' _newline <span class="stcmt">///</span>
&gt;         `"echo Found %%r"' _newline <span class="stcmt">///</span>
&gt;         `"echo shell "%PATHROOT%%%r\bin\x64\R.exe" CMD BATCH SLS.R &gt; runr.do"' _newline <span class="stcmt">///</span>
&gt;         `"echo All set!"' _newline <span class="stcmt">///  </span>
&gt;         `"goto:DONE"' _newline <span class="stcmt">///</span>
&gt; `")"' _newline <span class="stcmt">///</span>
&gt; `":NO_R"' _newline <span class="stcmt">///</span>
&gt; `"echo R is not installed in your system."' _newline <span class="stcmt">///</span>
&gt; `"echo."' _newline <span class="stcmt">///</span>
&gt; `"echo Download it from https://cran.r-project.org/bin/windows/base/"' _newline <span class="stcmt">///</span>
&gt; `"echo Install it and re-run this script"' _newline <span class="stcmt">///</span>
&gt; `":DONE"' _newline <span class="stcmt">///</span>
&gt; `"echo."' _newline <span class="stcmt">///</span>
&gt; `"pause"'</span>
 10<span class="stinp">. qui: file close bat</span>
 11<span class="stinp">. </span>
<span class="stinp">. //Run batch</span>
<span class="stinp">. shell setup.bat </span>
 12<span class="stinp">. //Run R </span>
<span class="stinp">. do runr.do</span>
 13<span class="stinp">. </span>
<span class="stinp">. // Read Revised Data Back to Stata</span>
<span class="stinp">. clear</span>
 14<span class="stinp">. quietly: use "data2.dta", clear</span>
 15<span class="stinp">. </span>
<span class="stinp">. // Q to logit scale</span>
<span class="stinp">. gen logQAW = log(QAW / (1 - QAW))</span>
 16<span class="stinp">. gen logQ1W = log(Q1W / (1 - Q1W))</span>
 17<span class="stinp">. gen logQ0W = log(Q0W / (1 - Q0W))</span>
 18<span class="stinp">.  </span>
<span class="stinp">. // Clever covariate HAW</span>
<span class="stinp">. gen double HAW = (A / ps) - ((1 - A) / (1 - ps))</span>
 19<span class="stinp">. gen double H1W = 1 / ps</span>
 20<span class="stinp">. gen double H0W = -1 / (1 - ps)</span>
 21<span class="stinp">. </span>
<span class="stinp">. // Estimation of the substitution parameter (Epsilon)</span>
<span class="stinp">. qui glm Y HAW, fam(binomial) offset(logQAW) robust noconstant</span>
 22<span class="stinp">. mat a= e(b)</span>
 23<span class="stinp">. gen double epsilon = a[1,1]</span>
 24<span class="stinp">. </span>
<span class="stinp">. // Targeted ATE, update from Q^0 (A,W)to Q^1 (A,W)</span>
<span class="stinp">. </span>
<span class="stinp">. gen double  Qstar = exp(HAW*epsilon + logQAW)/(1 + exp(HAW*epsilon + logQAW))</span>
 25<span class="stinp">. gen double Q0star = exp(H0W*epsilon + logQ0W)/(1 + exp(H0W*epsilon + logQ0W))</span>
 26<span class="stinp">. gen double Q1star = exp(H1W*epsilon + logQ1W)/(1 + exp(H1W*epsilon + logQ1W))</span>
 27<span class="stinp">. </span>
<span class="stinp">. global cf = $b - $a</span>
 28<span class="stinp">. </span>
<span class="stinp">. gen double POM1 = cond($flag==1,Q1star,Q1star*($cf),.)</span>
 29<span class="stinp">. gen double POM0 = cond($flag==1,Q0star,Q0star*($cf),.)</span>
 30<span class="stinp">. gen double   PO = cond($flag==1,Qstar,Qstar*($cf),.)</span>
 31<span class="stinp">. </span>
<span class="stinp">. gen    WT = HAW</span>
 32<span class="stinp">. gen    PS = ps</span>
 33<span class="stinp">. summ   POM1 POM0 WT PS</span>
 34<span class="stinp">. </span>
<span class="stinp">. // Estimating the updated targeted ATE binary outcome</span>
<span class="stinp">. gen double ATE = cond($flag==1,(Q1star - Q0star),(Q1star - Q0star)*($cf),.)</span>
 35<span class="stinp">. qui sum ATE</span>
 36<span class="stinp">. global ATEtmle = r(mean)</span>
 37<span class="stinp">. </span>
<span class="stinp">. // ATE continuous outcome </span>
<span class="stinp">. gen double ATEci = (Q1star - Q0star)</span>
 38<span class="stinp">. qui sum ATEci </span>
 39<span class="stinp">. global ATEci = r(mean)</span>
 40<span class="stinp">. </span>
<span class="stinp">. // Relative risk</span>
<span class="stinp">. qui sum Q1star</span>
 41<span class="stinp">. global Q1 = r(mean)</span>
 42<span class="stinp">. qui sum Q0star</span>
 43<span class="stinp">. global Q0 = r(mean)</span>
 44<span class="stinp">. global RRtmle = $Q1/$Q0</span>
 45<span class="stinp">. </span>
<span class="stinp">. // Statistical inference ATE </span>
<span class="stinp">. gen double IC = cond($flag==1,HAW*(Y - Qstar) + (Q1star - Q0star) - $ATEci,(HAW*(Y - Qstar) + (Q1star - Q0star) - $ATEci)*$cf,.)</span>
 46<span class="stinp">. </span>
<span class="stinp">. qui sum IC</span>
 47<span class="stinp">. global var = r(Var)</span>
 48<span class="stinp">. qui count</span>
 49<span class="stinp">. global n = r(N)</span>
 50<span class="stinp">. global varICtmle = $var/$n</span>
 51<span class="stinp">. </span>
<span class="stinp">. global pvalue = cond($flag==1,2*(normalden(abs($ATEci/sqrt($varICtmle)))),2*(normalden(abs($ATEtmle/sqrt($varICtmle)))),.)</span>
 52<span class="stinp">. </span>
<span class="stinp">. global LCIa =  cond($flag==1,$ATEci -1.96*sqrt($varICtmle),$ATEtmle -1.96*sqrt($varICtmle),.)</span>
 53<span class="stinp">. global UCIa =  cond($flag==1,$ATEci +1.96*sqrt($varICtmle),$ATEtmle +1.96*sqrt($varICtmle),.)</span>
 54<span class="stinp">. </span>
<span class="stinp">. // Statistical inference RR</span>
<span class="stinp">. gen double ICrr = 1/Q1star*((A/ps)*(Y - QAW) + (Q1W) - Q1star) - 1/Q0star*((1-A)/(1-ps)*(Y - QAW) + (Q0W) - Q0star)</span>
 55<span class="stinp">. qui sum ICrr</span>
 56<span class="stinp">. global varr = r(Var)</span>
 57<span class="stinp">. global varICrr = $varr/$n</span>
 58<span class="stinp">. </span>
<span class="stinp">. global LCIr =  exp(log($RRtmle) - 1.96*sqrt($varICrr))</span>
 59<span class="stinp">. global UCIr =  exp(log($RRtmle) + 1.96*sqrt($varICrr))</span>
 60<span class="stinp">. </span>
<span class="stinp">. // IC for Additive Risk differences</span>
<span class="stinp">. gen double ICrd = HAW*(Y - Qstar) + (Q1star - Q0star) - $ATEci</span>
 61<span class="stinp">. qui sum ICrd</span>
 62<span class="stinp">. global varrd = r(Var)</span>
 63<span class="stinp">. global varICrd = $varrd/$n</span>
 64<span class="stinp">. global LCIard =  $ATEci -1.96*sqrt($varICrd)</span>
 65<span class="stinp">. global UCIard =  $ATEci +1.96*sqrt($varICrd)</span>
 66<span class="stinp">. </span>
<span class="stinp">. // Display Results </span>
<span class="stinp">. local bin  ""ACE (Risk Differences):" %10.4f $ATEtmle _col(5) "; SE:" %10.5f sqrt($varICtmle) _col(5) "; p-value:" %7.4f $pvalue _col(5) "; 95%CI:("  %5.4f $LCIa ","   %7.4f $UCIa ")""</span>
 67<span class="stinp">. local cont ""ACE (Additive Effect):" %10.4f $ATEtmle _col(5) "; Estimated Variance:" %10.4f $varICtmle _col(5) "; p-value:" %7.4f $pvalue _col(5) "; 95%CI:("  %8.2f $LCIa ","  %9.2f $UCIa "
&gt; )""</span>
 68<span class="stinp">. local contrd  ""ACE (Risk Differences):" %10.4f $ATEci _col(5) "; SE:" %10.5f sqrt($varICrd) _col(5) "; p-value:" %7.4f $pvalue _col(5) "; 95%CI:("  %5.4f $LCIard ","  %7.4f $UCIard ")""</span>
 69<span class="stinp">. </span>
<span class="stinp">. if $flag==1 {</span>
 70<span class="stinp">. di _newline</span>
 71<span class="stinp">. di "TMLE: Average Causal Effect" _newline</span>
 72<span class="stinp">. di `bin'</span>
 73<span class="stinp">. }</span>
 74<span class="stinp">. else if $flag!=1{</span>
 75<span class="stinp">. di _newline</span>
 76<span class="stinp">. di `cont'</span>
 77<span class="stinp">. di _newline</span>
 78<span class="stinp">. di `contrd'</span>
 79<span class="stinp">. }</span>
 80<span class="stinp">. </span>
<span class="stinp">. local rrbin ""RR:" %9.4f $RRtmle _col(5) "; 95%CI:(" %5.4f $LCIr "," %7.4f $UCIr ")""</span>
 81<span class="stinp">. if $flag==1 {</span>
 82<span class="stinp">. di _newline</span>
 83<span class="stinp">. di "TMLE: Causal Relative Risk" _newline </span>
 84<span class="stinp">. display `rrbin'</span>
 85<span class="stinp">. }</span>
 86<span class="stinp">. else if $flag!=1{</span>
 87<span class="stinp">. }</span>
 88<span class="stinp">. </span>
<span class="stinp">. drop ATEci ICrr ICrd logQAW logQ1W logQ0W HAW H1W H0W QAW Q1W Q0W Qstar Q1star Q0star ps Y A epsilon</span>
 89<span class="stinp">. </span>
<span class="stinp">. label var POM1 "Potential Outcome Y(1)"</span>
 90<span class="stinp">. label var POM0 "Potential Otucome Y(0)"</span>
 91<span class="stinp">. label var ATE "Average Treatment Effect"</span>
 92<span class="stinp">. label var WT "Inverse Probability Treatment Weights"</span>
 93<span class="stinp">. label var IC "Variance ATE"</span>
 94<span class="stinp">. label var PS "Propensity Score"</span>
 95<span class="stinp">. </span>
<span class="stinp">. // Clean up</span>
<span class="stinp">. quietly: rm SLS.R</span>
 96<span class="stinp">. //quietly: rm SLS.Rout</span>
<span class="stinp">. quietly: rm data2.dta</span>
 97<span class="stinp">. quietly: rm data.csv</span>
 98<span class="stinp">. quietly: rm .RData</span>
 99<span class="stinp">. quietly: rm runr.do</span>
100<span class="stinp">. quietly: rm setup.bat </span>
101<span class="stinp">. end</span>
</samp></pre>
<h3><font color="blue">THANK YOU FOR YOUR ATTENTION</font></h3>
</body>
</html>
</body>
</html>
